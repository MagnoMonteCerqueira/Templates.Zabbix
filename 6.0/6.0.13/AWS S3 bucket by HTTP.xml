<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>6.0</version><date>2023-02-11T16:15:10Z</date><groups><group><uuid>c2c162144c2d4c5491c8801193af4945</uuid><name>Templates/Cloud</name></group></groups><templates><template><uuid>a14ab6b4e80643fe8daa9d7288658f79</uuid><template>AWS S3 bucket by HTTP</template><name>AWS S3 bucket by HTTP</name><description>The template gets AWS S3 bucket metrics and uses the script item to make HTTP requests to the CloudWatch API.
Don't forget to read the README.md for the correct setup of the template.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Template tooling version used: 0.42</description><groups><group><name>Templates/Cloud</name></group></groups><items><item><uuid>7c746594159f4f1c94e8790ed1bdf2af</uuid><name>AWS S3: Requests: Errors, 4xx</name><type>DEPENDENT</type><key>aws.s3.4xx_errors</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP 4xx client error status code requests made to an Amazon S3 bucket with a value of either 0 or 1. 
The average statistic shows the error rate, and the sum statistic shows the count of that type of error, during each period.
Statistic: Average (reports per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;4xxErrors&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>errors</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>806de74ed57b4797b294ebe8fa509429</uuid><name>AWS S3: Requests: Errors, 5xx</name><type>DEPENDENT</type><key>aws.s3.5xx_errors</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP 5xx server error status code requests made to an Amazon S3 bucket with a value of either 0 or 1. 
The average statistic shows the error rate, and the sum statistic shows the count of that type of error, during each period.
Statistic: Average (reports per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;5xxErrors&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>errors</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>7ca108eafb0d4b65a304815ee637174e</uuid><name>AWS S3: Get alarms check</name><type>DEPENDENT</type><key>aws.s3.alarms.check</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>CHAR</value_type><description>Data collection check.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.error</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>3h</parameter></parameters></step></preprocessing><master_item><key>aws.s3.get_alarms</key></master_item><tags><tag><tag>component</tag><value>status</value></tag></tags><triggers><trigger><uuid>a8f8a7518aad4e32b23a8611afc8f48c</uuid><expression>length(last(/AWS S3 bucket by HTTP/aws.s3.alarms.check))&gt;0</expression><name>AWS S3: Failed to get alarms data</name><opdata>{ITEM.LASTVALUE1}</opdata><priority>WARNING</priority><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>7530d7ebe61942f4abc29a8ccb3b5516</uuid><name>AWS S3: Requests: All</name><type>DEPENDENT</type><key>aws.s3.all_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The total number of HTTP requests made to an Amazon S3 bucket, regardless of type.
If you're using a metrics configuration with a filter, then this metric only returns the HTTP requests that meet the filter's requirements.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;AllRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>fceb9927715443059269fa4589f90f67</uuid><name>AWS S3: Bucket Size</name><type>DEPENDENT</type><key>aws.s3.bucket_size_bytes</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>This a daily metric for the bucket.
The amount of data in bytes stored in a bucket in the STANDARD storage class, INTELLIGENT_TIERING storage class, Standard-Infrequent Access (STANDARD_IA) storage class, OneZone-Infrequent Access (ONEZONE_IA), Reduced Redundancy Storage (RRS) class, S3 Glacier Instant Retrieval storage class, Deep Archive Storage (S3 Glacier Deep Archive) class or, S3 Glacier Flexible Retrieval (GLACIER) storage class. This value is calculated by summing the size of all objects and metadata in the bucket (both current and noncurrent objects), including the size of all parts for all incomplete multipart uploads to the bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;BucketSizeBytes&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>8758c16faef9477d8e3ff41426c2761b</uuid><name>AWS S3: Requests: Bytes downloaded</name><type>DEPENDENT</type><key>aws.s3.bytes_downloaded</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The number of bytes downloaded for requests made to an Amazon S3 bucket, where the response includes a body.
Statistic: Average (bytes per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;BytesDownloaded&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>3f5141a7448b43d288a37dfe41a52288</uuid><name>AWS S3: Replication: Bytes pending</name><type>DEPENDENT</type><key>aws.s3.bytes_pending_replication</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The total number of bytes of objects pending replication for a given replication rule.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;BytesPendingReplication&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>replication</value></tag></tags></item><item><uuid>99eefab6b9be405ead0e6ea57394a7e3</uuid><name>AWS S3: Requests: Bytes uploaded</name><type>DEPENDENT</type><key>aws.s3.bytes_uploaded</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The number of bytes uploaded that contain a request body, made to an Amazon S3 bucket.
Statistic: Average (bytes per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;BytesUploaded&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>d9deb58254be4add996d3dec97344132</uuid><name>AWS S3: Requests: Delete</name><type>DEPENDENT</type><key>aws.s3.delete_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP DELETE requests made for objects in an Amazon S3 bucket.
This also includes Delete Multiple Objects requests. This metric shows the number of requests, not the number of objects deleted.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;DeleteRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>d8c8e91f383747e5b6e73f922f5b3278</uuid><name>AWS S3: First byte latency, avg</name><type>DEPENDENT</type><key>aws.s3.first_byte_latency.avg</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>ms</units><description>The per-request time from the complete request being received by an Amazon S3 bucket to when the response starts to be returned.
Statistic: Average.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;FirstByteLatency&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>latency</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>55cb2316171e43a0aa94e0d203832577</uuid><name>AWS S3: First byte latency, p90</name><type>DEPENDENT</type><key>aws.s3.first_byte_latency.p90</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>ms</units><description>The per-request time from the complete request being received by an Amazon S3 bucket to when the response starts to be returned.
Statistic: 90 percentile.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;FirstByteLatency&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>latency</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>6da0ea7130e64a7fb8ae32ee02290cbf</uuid><name>AWS S3: Get alarms data</name><type>SCRIPT</type><key>aws.s3.get_alarms</key><delay>0s;m/1</delay><history>0</history><trends>0</trends><value_type>TEXT</value_type><params>var AwsS3 = {
    params: {},

    setParams: function (params) {
        ['access_key', 'secret_key', 'region', 'bucket_name'].forEach(function (field) {
            if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
                throw 'Required param is not set: &quot;' + field + '&quot;.';
            }
        });

        AwsS3.params = params;
    },

    sign: function (key, message) {
        var hex = hmac('sha256', key, message);

        if ((hex.length % 2) === 1) {
            throw 'Invalid length of a hex string!';
        }

        var result = new Int8Array(hex.length / 2);
        for (var i = 0, b = 0; i &lt; hex.length; i += 2, b++) {
            result[b] = parseInt(hex.substring(i, i + 2), 16);
        }

        return result;
    },

    prepareParams: function (params) {
        var result = [];

        Object.keys(params).sort().forEach(function (key) {
            if (typeof params[key] !== 'object') {
                result.push(key + '=' + encodeURIComponent(params[key]));
            }
            else {
                result.push(prepareObject(key, params[key]));
            }
        });

        return result.join('&amp;');
    },

    request: function (method, region, service, params, data) {
        if (typeof data === 'undefined' || data === null) {
            data = '';
        }

        var amzdate = (new Date()).toISOString().replace(/\.\d+Z/, 'Z').replace(/[-:]/g, ''),
            date = amzdate.replace(/T\d+Z/, ''),
            host = service + '.' + region + '.amazonaws.com',
            canonical_uri = '/',
            canonical_headers = 'content-encoding:amz-1.0\n' + 'host:' + host + '\n' + 'x-amz-date:' + amzdate + '\n',
            signed_headers = 'content-encoding;host;x-amz-date',
            canonical_request = method + '\n' + canonical_uri + '\n' + params + '\n' + canonical_headers + '\n' + signed_headers + '\n' + sha256(data),
            credential_scope = date + '/' + region + '/' + service + '/' + 'aws4_request',
            request_string = 'AWS4-HMAC-SHA256' + '\n' + amzdate + '\n' + credential_scope + '\n' + sha256(canonical_request),
            key = AwsS3.sign('AWS4' + AwsS3.params.secret_key, date);

        key = AwsS3.sign(key, region);
        key = AwsS3.sign(key, service);
        key = AwsS3.sign(key, 'aws4_request');

        var request = new HttpRequest(),
            url = 'https://' + host + canonical_uri + '?' + params;

        if (typeof AwsS3.params.proxy !== 'undefined' &amp;&amp; AwsS3.params.proxy !== '') {
            request.setProxy(AwsS3.params.proxy);
        }
        request.addHeader('x-amz-date: ' + amzdate);
        request.addHeader('Accept: application/json');
        request.addHeader('Content-Type: application/json');
        request.addHeader('Content-Encoding: amz-1.0');
        request.addHeader('Authorization: ' + 'AWS4-HMAC-SHA256 Credential=' + AwsS3.params.access_key + '/' + credential_scope + ', ' + 'SignedHeaders=' + signed_headers + ', ' + 'Signature=' + hmac('sha256', key, request_string));

        Zabbix.log(4, '[ AWS S3 ] Sending request: ' + url);

        response = request.get(url);

        Zabbix.log(4, '[ AWS S3 ] Received response with status code ' + request.getStatus() + ': ' + response);

        if (request.getStatus() !== 200) {
            throw 'Request failed with status code ' + request.getStatus() + ': ' + response;
        }

        if (response[0] === '&lt;') {
            try {
                response = XML.toJson(response);
            }
            catch (error) {
                throw 'Failed to parse response received from AWS CloudWatch API. Check debug log for more information.';
            }
        }

        if (response !== null) {
            try {
                response = JSON.parse(response);
            }
            catch (error) {
                throw 'Failed to parse response received from AWS CloudWatch API. Check debug log for more information.';
            }
        }

        return response;
    },

    getAlarms: function () {
        var payload = {},
            result = [];

        payload['Action'] = 'DescribeAlarms';
        payload['MaxRecords'] = 100;
        payload['Version'] = '2010-08-01';

        while (payload.NextToken !== '') {
            var alarms = AwsS3.request('GET', AwsS3.params.region, 'monitoring', AwsS3.prepareParams(payload));

            if (typeof alarms !== 'object'
                || typeof alarms.DescribeAlarmsResponse !== 'object'
                || typeof alarms.DescribeAlarmsResponse.DescribeAlarmsResult !== 'object'
                || typeof alarms.DescribeAlarmsResponse.DescribeAlarmsResult.MetricAlarms !== 'object') {
                throw 'Cannot get alarms from AWS CloudWatch API. Check debug log for more information.';
            }

            payload.NextToken = alarms.DescribeAlarmsResponse.DescribeAlarmsResult.NextToken || '';

            if (!Array.isArray(alarms.DescribeAlarmsResponse.DescribeAlarmsResult.MetricAlarms))
                alarms.DescribeAlarmsResponse.DescribeAlarmsResult.MetricAlarms = [alarms.DescribeAlarmsResponse.DescribeAlarmsResult.MetricAlarms]
            alarms.DescribeAlarmsResponse.DescribeAlarmsResult.MetricAlarms.forEach(function (alarm) {
                var dimensions = alarm.Dimensions;

                if (Array.isArray(alarm.Metrics)) {
                    alarm.Metrics.forEach(function (metric) {
                        if (typeof metric.MetricStat === 'object' &amp;&amp; metric.MetricStat !== null
                            &amp;&amp; typeof metric.MetricStat.Metric === 'object' &amp;&amp; metric.MetricStat.Metric !== null
                            &amp;&amp; Array.isArray(metric.MetricStat.Metric.Dimensions)) {
                            dimensions = dimensions.concat(metric.MetricStat.Metric.Dimensions);
                        }
                    });
                }
                for (var i in dimensions) {
                    if (dimensions[i].Name === 'BucketName' &amp;&amp; dimensions[i].Value === AwsS3.params.bucket_name) {
                        result.push(alarm);
                        break;
                    }
                }
            });
        }

        return result;
    }
}

try {
    AwsS3.setParams(JSON.parse(value));

    return JSON.stringify(AwsS3.getAlarms());
}
catch (error) {
    error += (String(error).endsWith('.')) ? '' : '.';
    Zabbix.log(3, '[ AWS S3 ] ERROR: ' + error);

    return JSON.stringify({ 'error': error });
}</params><description>Get alarms data.
DescribeAlarms API method: https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_DescribeAlarms.html</description><preprocessing><step><type>CHECK_NOT_SUPPORTED</type><parameters><parameter/></parameters></step></preprocessing><timeout>15s</timeout><parameters><parameter><name>access_key</name><value>{$AWS.ACCESS.KEY.ID}</value></parameter><parameter><name>secret_key</name><value>{$AWS.SECRET.ACCESS.KEY}</value></parameter><parameter><name>region</name><value>{$AWS.REGION}</value></parameter><parameter><name>bucket_name</name><value>{$AWS.S3.BUCKET.NAME}</value></parameter><parameter><name>proxy</name><value>{$AWS.PROXY}</value></parameter></parameters><tags><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>598e9dc563334ad6b1d72245a6f8679f</uuid><name>AWS S3: Get metrics data</name><type>SCRIPT</type><key>aws.s3.get_metrics</key><delay>0s;m/1</delay><history>0</history><trends>0</trends><value_type>TEXT</value_type><params>var AwsS3 = {
    params: {},
    request_period: 180,

    setParams: function (params) {
        ['access_key', 'secret_key', 'region', 'bucket_name', 'filter_id'].forEach(function (field) {
            if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
                throw 'Required param is not set: &quot;' + field + '&quot;.';
            }
        });

        AwsS3.params = params;
    },

    sign: function (key, message) {
        var hex = hmac('sha256', key, message);

        if ((hex.length % 2) === 1) {
            throw 'Invalid length of a hex string!';
        }

        var result = new Int8Array(hex.length / 2);
        for (var i = 0, b = 0; i &lt; hex.length; i += 2, b++) {
            result[b] = parseInt(hex.substring(i, i + 2), 16);
        }

        return result;
    },

    renderMetricQuery: function (period, bucket_name, filter_id) {
        var metrics_list = [
            'BucketSizeBytes:Bytes:Average',
            'NumberOfObjects:Count:Average',
            'AllRequests:Count:Sum',
            'GetRequests:Count:Sum',
            'PutRequests:Count:Sum',
            'DeleteRequests:Count:Sum',
            'HeadRequests:Count:Sum',
            'PostRequests:Count:Sum',
            'SelectRequests:Count:Sum',
            'SelectBytesScanned:Bytes:Average',
            'SelectBytesReturned:Bytes:Average',
            'ListRequests:Count:Sum',
            'BytesDownloaded:Bytes:Average',
            'BytesUploaded:Bytes:Average',
            '4xxErrors:Count:Average',
            '5xxErrors:Count:Average',
            'FirstByteLatency:Milliseconds:p90',
            'TotalRequestLatency:Milliseconds:p90',
            'FirstByteLatency:Milliseconds:p90',
            'ReplicationLatency:Seconds:Average',
            'BytesPendingReplication:Bytes:Average',
            'OperationsPendingReplication:Count:Average',

        ];

        var metric_payload = [];
        metrics_list.forEach(function (metric, index) {
            var parts = metric.split(':', 3);
            metric_payload.push({
                'Id': 'm' + index,
                'MetricStat': {
                    'Metric': {
                        'MetricName': parts[0],
                        'Namespace': 'AWS/S3',
                        'Dimensions': [
                            {
                                'Name': 'BucketName',
                                'Value': bucket_name
                            },
                            {
                                'Name': 'FilterId',
                                'Value': filter_id
                            }
                        ]
                    },
                    'Period': period,
                    'Stat': parts[2],
                    'Unit': parts[1]
                }
            });
        });

        return metric_payload;

    },
    prepareParams: function (params) {
        var result = [];

        Object.keys(params).sort().forEach(function (key) {
            if (typeof params[key] !== 'object') {
                result.push(key + '=' + encodeURIComponent(params[key]));
            }
            else {
                result.push(prepareObject(key, params[key]));
            }
        });

        return result.join('&amp;');
    },

    request: function (method, region, service, request_data) {
        if (typeof request_data === 'undefined' || request_data === null) {
            request_data = '';
        }
        else {
            request_data = JSON.stringify(request_data)
        }

        var amzdate = (new Date()).toISOString().replace(/\.\d+Z/, 'Z').replace(/[-:]/g, ''),
            date = amzdate.replace(/T\d+Z/, ''),
            host = service + '.' + region + '.amazonaws.com',
            canonical_uri = '/',
            canonical_headers = 'content-encoding:amz-1.0\n' + 'host:' + host + '\n' + 'x-amz-date:' + amzdate + '\n',
            signed_headers = 'content-encoding;host;x-amz-date',
            canonical_request = method + '\n' + canonical_uri + '\n' + '\n' + canonical_headers + '\n' + signed_headers + '\n' + sha256(request_data),
            credential_scope = date + '/' + region + '/' + service + '/' + 'aws4_request',
            request_string = 'AWS4-HMAC-SHA256' + '\n' + amzdate + '\n' + credential_scope + '\n' + sha256(canonical_request),
            key = AwsS3.sign('AWS4' + AwsS3.params.secret_key, date);

        key = AwsS3.sign(key, region);
        key = AwsS3.sign(key, service);
        key = AwsS3.sign(key, 'aws4_request');

        var request = new HttpRequest(),
            url = 'https://' + host + canonical_uri;

        if (typeof AwsS3.params.proxy !== 'undefined' &amp;&amp; AwsS3.params.proxy !== '') {
            request.setProxy(AwsS3.params.proxy);
        }
        request.addHeader('x-amz-date: ' + amzdate);
        request.addHeader('X-Amz-Target: GraniteServiceVersion20100801.GetMetricData')
        request.addHeader('Accept: application/json');
        request.addHeader('Content-Type: application/json');
        request.addHeader('Content-Encoding: amz-1.0');
        request.addHeader('Authorization: ' + 'AWS4-HMAC-SHA256 Credential=' + AwsS3.params.access_key + '/' + credential_scope + ', ' + 'SignedHeaders=' + signed_headers + ', ' + 'Signature=' + hmac('sha256', key, request_string));

        Zabbix.log(4, '[ AWS S3 ] Sending request: ' + url);

        response = request.post(url, request_data);
        Zabbix.log(4, '[ AWS S3 ] Received response with status code ' + request.getStatus() + ': ' + response);

        if (request.getStatus() !== 200) {
            throw 'Request failed with status code ' + request.getStatus() + ': ' + response;
        }

        if (response !== null) {
            try {
                response = JSON.parse(response);
            }
            catch (error) {
                throw 'Failed to parse response received from AWS CloudWatch API. Check debug log for more information.';
            }
        }

        return response;
    },

    getMetricsData: function () {
        var payload = {},
            end_time = Math.floor((new Date().getTime()) / 1000),
            start_time = end_time - AwsS3.request_period;

        payload['StartTime'] = start_time;
        payload['EndTime'] = end_time;
        payload['ScanBy'] = 'TimestampDescending';
        payload['MetricDataQueries'] = AwsS3.renderMetricQuery(60, AwsS3.params.bucket_name, AwsS3.params.filter_id);
        result = AwsS3.request('POST', AwsS3.params.region, 'monitoring', payload);
        if (typeof result !== 'object' || typeof result.MetricDataResults !== 'object') {
            throw 'Cannot get metrics data from AWS CloudWatch API. Check debug log for more information.';
        }

        return result.MetricDataResults;
    }
};

try {
    AwsS3.setParams(JSON.parse(value));

    return JSON.stringify(AwsS3.getMetricsData());
}
catch (error) {
    return error
    // error += (String(error).endsWith('.')) ? '' : '.';
    // Zabbix.log(3, '[ AWS S3 ] ERROR: ' + error);

    // return JSON.stringify({'error': error});
}</params><description>Get bucket metrics.
Full metrics list related to S3: https://docs.aws.amazon.com/AmazonS3/latest/userguide/metrics-dimensions.html</description><preprocessing><step><type>CHECK_NOT_SUPPORTED</type><parameters><parameter/></parameters></step></preprocessing><timeout>15s</timeout><parameters><parameter><name>access_key</name><value>{$AWS.ACCESS.KEY.ID}</value></parameter><parameter><name>secret_key</name><value>{$AWS.SECRET.ACCESS.KEY}</value></parameter><parameter><name>region</name><value>{$AWS.REGION}</value></parameter><parameter><name>filter_id</name><value>{$AWS.S3.FILTER.ID}</value></parameter><parameter><name>bucket_name</name><value>{$AWS.S3.BUCKET.NAME}</value></parameter><parameter><name>proxy</name><value>{$AWS.PROXY}</value></parameter></parameters><tags><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>f2cff8aa3c3c4a308296550561b02829</uuid><name>AWS S3: Requests: Get</name><type>DEPENDENT</type><key>aws.s3.get_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP GET requests made for objects in an Amazon S3 bucket. This doesn't include list operations.
Paginated list-oriented requests, like List Multipart Uploads, List Parts, Get Bucket Object versions, and others, are not included in this metric.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;GetRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>0d9f59f099cb47c8991cc2e353154dc7</uuid><name>AWS S3: Requests: Head</name><type>DEPENDENT</type><key>aws.s3.head_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP HEAD requests made to an Amazon S3 bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;HeadRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>f9b09dbbf0a44ea9b34a86853a6ebfd0</uuid><name>AWS S3: Requests: List</name><type>DEPENDENT</type><key>aws.s3.list_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP requests that list the contents of a bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;ListRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>0e22c196ae834d2899068f25316ffed2</uuid><name>AWS S3: Get metrics check</name><type>DEPENDENT</type><key>aws.s3.metrics.check</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>CHAR</value_type><description>Data collection check.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.error</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>3h</parameter></parameters></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>status</value></tag></tags><triggers><trigger><uuid>a8a0b4187f5f4e22b868dd038f53a2ba</uuid><expression>length(last(/AWS S3 bucket by HTTP/aws.s3.metrics.check))&gt;0</expression><name>AWS S3: Failed to get metrics data</name><opdata>{ITEM.LASTVALUE1}</opdata><priority>WARNING</priority><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>75b467e2079c41c5b3e8f79df8c5a9ba</uuid><name>AWS S3: Number of objects</name><type>DEPENDENT</type><key>aws.s3.number_of_objects</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>This a daily metric for the bucket.
The total number of objects stored in a bucket for all storage classes. 
This value is calculated by counting all objects in the bucket (both current and noncurrent objects) and the total number of parts for all incomplete multipart uploads to the bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;NumberOfObjects&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>ad753554ca7e45629e7eb144a3595228</uuid><name>AWS S3: Replication: Operations pending</name><type>DEPENDENT</type><key>aws.s3.operations_pending_replication</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of operations pending replication for a given replication rule.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;OperationsPendingReplication&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>replication</value></tag></tags></item><item><uuid>9bb4416c7c454e5486a7ce4e4b4b90f0</uuid><name>AWS S3: Requests: Post</name><type>DEPENDENT</type><key>aws.s3.post_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP POST requests made to an Amazon S3 bucket.
Delete Multiple Objects and SELECT Object Content requests are not included in this metric.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;PostRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>88a67025c835410eb54d74be96cf5b4c</uuid><name>AWS S3: Requests: Put</name><type>DEPENDENT</type><key>aws.s3.put_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of HTTP PUT requests made for objects in an Amazon S3 bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;PutRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>ac0f6d6f6f2247379d99fa2f4f0ecc11</uuid><name>AWS S3: Replication: Latency</name><type>DEPENDENT</type><key>aws.s3.replication_latency</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>s</units><description>The maximum number of seconds by which the replication destination Region is behind the source Region for a given replication rule.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;ReplicationLatency&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>replication</value></tag></tags></item><item><uuid>23c13e717a2845399068e7c2e627df4f</uuid><name>AWS S3: Requests: Select, bytes returned</name><type>DEPENDENT</type><key>aws.s3.select_bytes_returned</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The number of bytes of data returned with Amazon S3 SELECT Object Content requests in an Amazon S3 buckets.
Statistic: Average (bytes per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;SelectBytesReturned&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>042e84dc68c54390a3d0427b87d89e47</uuid><name>AWS S3: Requests: Select, bytes scanned</name><type>DEPENDENT</type><key>aws.s3.select_bytes_scanned</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The number of bytes of data scanned with Amazon S3 SELECT Object Content requests in an Amazon S3 bucket.
Statistic: Average (bytes per request).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;SelectBytesScanned&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>616ec102597447cdbe2f21186937dcfe</uuid><name>AWS S3: Requests: Select</name><type>DEPENDENT</type><key>aws.s3.select_requests</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of Amazon S3 SELECT Object Content requests made for objects in an Amazon S3 bucket.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;SelectRequests&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>effa8475024843249ad213d726323e72</uuid><name>AWS S3: Total request latency, avg</name><type>DEPENDENT</type><key>aws.s3.total_request_latency.avg</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>ms</units><description>The elapsed per-request time from the first byte received to the last byte sent to an Amazon S3 bucket.
This includes the time taken to receive the request body and send the response body, which is not included in FirstByteLatency.
Statistic: Average.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;TotalRequestLatency&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>latency</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item><item><uuid>886b748066834f01aa2f6f9327fceba0</uuid><name>AWS S3: Total request latency, p90</name><type>DEPENDENT</type><key>aws.s3.total_request_latency.p90</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>ms</units><description>The elapsed per-request time from the first byte received to the last byte sent to an Amazon S3 bucket.
This includes the time taken to receive the request body and send the response body, which is not included in FirstByteLatency.
Statistic: 90 percentile.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.Label == &quot;TotalRequestLatency&quot;)].Values.first().first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>aws.s3.get_metrics</key></master_item><tags><tag><tag>component</tag><value>latency</value></tag><tag><tag>component</tag><value>requests</value></tag></tags></item></items><discovery_rules><discovery_rule><uuid>26c424a60a7a4975996ccc44601c4ee3</uuid><name>Bucket Alarms discovery</name><type>DEPENDENT</type><key>aws.s3.alarms.discovery</key><delay>0</delay><filter><evaltype>AND</evaltype><conditions><condition><macro>{#ALARM_NAME}</macro><value>{$AWS.S3.LLD.FILTER.ALARM_NAME.MATCHES}</value><formulaid>A</formulaid></condition><condition><macro>{#ALARM_NAME}</macro><value>{$AWS.S3.LLD.FILTER.ALARM_NAME.NOT_MATCHES}</value><operator>NOT_MATCHES_REGEX</operator><formulaid>B</formulaid></condition></conditions></filter><description>Discovery bucket alarms.</description><item_prototypes><item_prototype><uuid>b38bd6e4566445acb52e8ecce4014f0f</uuid><name>AWS S3 Alarms: [&quot;{#ALARM_NAME}&quot;]: State</name><type>DEPENDENT</type><key>aws.s3.alarm.state[&quot;{#ALARM_NAME}&quot;]</key><delay>0</delay><history>7d</history><description>The state value for the alarm. Possible values: 0 (OK), 1 (INSUFFICIENT_DATA), 2 (ALARM).
Alarm description:
{#ALARM_DESCRIPTION}</description><valuemap><name>Alarm state</name></valuemap><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.AlarmName == &quot;{#ALARM_NAME}&quot;)].StateValue.first()</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler><error_handler_params>3</error_handler_params></step><step><type>JAVASCRIPT</type><parameters><parameter>var state = ['OK', 'INSUFFICIENT_DATA', 'ALARM'];

return state.indexOf(value.trim()) === -1 ? 255 : state.indexOf(value.trim());</parameter></parameters></step></preprocessing><master_item><key>aws.s3.get_alarms</key></master_item><tags><tag><tag>component</tag><value>alarms</value></tag></tags><trigger_prototypes><trigger_prototype><uuid>7f0ba96047784510b734c0064d434edc</uuid><expression>last(/AWS S3 bucket by HTTP/aws.s3.alarm.state[&quot;{#ALARM_NAME}&quot;])=1</expression><name>AWS S3 Alarms: &quot;{#ALARM_NAME}&quot; has 'Insufficient data' state</name><priority>INFO</priority><tags><tag><tag>scope</tag><value>notice</value></tag></tags></trigger_prototype></trigger_prototypes></item_prototype><item_prototype><uuid>7e536a43faf742058d303ffe21cd9a8c</uuid><name>AWS S3 Alarms: [&quot;{#ALARM_NAME}&quot;]: State reason</name><type>DEPENDENT</type><key>aws.s3.alarm.state_reason[&quot;{#ALARM_NAME}&quot;]</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><description>An explanation for the alarm state, in text format.
Alarm description:
{#ALARM_DESCRIPTION}</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.[?(@.AlarmName == &quot;{#ALARM_NAME}&quot;)].StateReason.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>3h</parameter></parameters></step></preprocessing><master_item><key>aws.s3.get_alarms</key></master_item><tags><tag><tag>component</tag><value>alarms</value></tag></tags></item_prototype></item_prototypes><trigger_prototypes><trigger_prototype><uuid>c1b94199b7ac4cc9889ff0e724f7057d</uuid><expression>last(/AWS S3 bucket by HTTP/aws.s3.alarm.state[&quot;{#ALARM_NAME}&quot;])=2 and length(last(/AWS S3 bucket by HTTP/aws.s3.alarm.state_reason[&quot;{#ALARM_NAME}&quot;]))&gt;0</expression><name>AWS S3 Alarms: &quot;{#ALARM_NAME}&quot; has 'Alarm' state</name><priority>AVERAGE</priority><description>Alarm &quot;{#ALARM_NAME}&quot; has 'Alarm' state. 
Reason: {ITEM.LASTVALUE2}</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger_prototype></trigger_prototypes><master_item><key>aws.s3.get_alarms</key></master_item><preprocessing><step><type>JAVASCRIPT</type><parameters><parameter>var result = [];
var alarms = JSON.parse(value);

alarms.forEach(function(alarm) {

 result.push({
'{#ALARM_DESCRIPTION}': alarm.AlarmDescription !== null ? alarm.AlarmDescription : 'None' ,
'{#ALARM_NAME}': alarm.AlarmName,
'{#ALARM_PERIOD}': alarm.Period,
'{#METRIC_NAME}': alarm.MetricName
  });
});

return JSON.stringify(result);</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>3h</parameter></parameters></step></preprocessing></discovery_rule></discovery_rules><tags><tag><tag>class</tag><value>software</value></tag><tag><tag>target</tag><value>aws</value></tag><tag><tag>target</tag><value>s3</value></tag></tags><macros><macro><macro>{$AWS.ACCESS.KEY.ID}</macro><description>Access key ID.</description></macro><macro><macro>{$AWS.PROXY}</macro><description>Sets HTTP proxy value. If this macro is empty then no proxy is used.</description></macro><macro><macro>{$AWS.REGION}</macro><value>us-west-1</value><description>Amazon S3 Region code.</description></macro><macro><macro>{$AWS.S3.BUCKET.NAME}</macro><description>S3 bucket name.</description></macro><macro><macro>{$AWS.S3.FILTER.ID}</macro><description>S3 bucket requests filter identifier.</description></macro><macro><macro>{$AWS.S3.LLD.FILTER.ALARM_NAME.MATCHES}</macro><value>.*</value><description>Filter of discoverable alarms by name.</description></macro><macro><macro>{$AWS.S3.LLD.FILTER.ALARM_NAME.NOT_MATCHES}</macro><value>CHANGE_IF_NEEDED</value><description>Filter to exclude discovered alarms by name.</description></macro><macro><macro>{$AWS.SECRET.ACCESS.KEY}</macro><type>SECRET_TEXT</type><description>Secret access key.</description></macro></macros><valuemaps><valuemap><uuid>5f232f40f02246ab843c9aacdcf8d5c5</uuid><name>Alarm state</name><mappings><mapping><value>0</value><newvalue>OK</newvalue></mapping><mapping><value>1</value><newvalue>Insufficient data</newvalue></mapping><mapping><value>2</value><newvalue>Alarm</newvalue></mapping><mapping><value>255</value><newvalue>Unknown</newvalue></mapping></mappings></valuemap></valuemaps></template></templates></zabbix_export>
