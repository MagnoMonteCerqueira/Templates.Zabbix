<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>6.0</version><date>2023-02-11T16:14:53Z</date><groups><group><uuid>748ad4d098d447d492bb935c907f652f</uuid><name>Templates/Databases</name></group></groups><templates><template><uuid>8ec72ebbe3204d7789429640abcac610</uuid><template>TiDB by HTTP</template><name>TiDB by HTTP</name><description>The template to monitor TiDB server of TiDB cluster by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.
Don't forget to change the macros {$TIDB.URL}, {$TIDB.PORT}.

Template `TiDB by HTTP` â€” collects metrics by HTTP agent from PD /metrics endpoint and from monitoring API.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Template tooling version used: 0.41</description><groups><group><name>Templates/Databases</name></group></groups><items><item><uuid>f6c68d3961e04d5185ab38c12fa25532</uuid><name>TiDB: CPU</name><type>DEPENDENT</type><key>tidb.cpu.util</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>%</units><description>Total user and system CPU usage ratio.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_cpu_seconds_total&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step><step><type>MULTIPLIER</type><parameters><parameter>100</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>cpu</value></tag></tags></item><item><uuid>e1da33fc95ab46bcbe6bc6a68154d172</uuid><name>TiDB: DDL waiting jobs</name><type>DEPENDENT</type><key>tidb.ddl_waiting_jobs</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_ddl_waiting_jobs&quot;)].value.sum()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>operations</value></tag></tags><triggers><trigger><uuid>4125d55d9931455091d2f3a0b25e9678</uuid><expression>min(/TiDB by HTTP/tidb.ddl_waiting_jobs,5m)&gt;{$TIDB.DDL.WAITING.MAX.WARN}</expression><name>TiDB: Too many DDL waiting jobs</name><event_name>TiDB: Too many DDL waiting jobs (over {$TIDB.DDL.WAITING.MAX.WARN} for 5m)</event_name><priority>WARNING</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item><item><uuid>0fe0c1dee67e469d9d38193ef7b040ec</uuid><name>TiDB: Load schema failed, rate</name><type>DEPENDENT</type><key>tidb.domain_load_schema.failed.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The total number of failures to reload the latest schema information in TiDB per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_domain_load_schema_total &amp;&amp; @.labels.type == &quot;failed&quot;&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>domain</value></tag></tags><triggers><trigger><uuid>b4948f37af804c01a2b8887f9e89ec90</uuid><expression>min(/TiDB by HTTP/tidb.domain_load_schema.failed.rate,5m)&gt;{$TIDB.SCHEMA_LOAD_ERRORS.MAX.WARN}</expression><name>TiDB: Too many schema lease errors</name><event_name>TiDB: Too many schema lease errors (over {$TIDB.SCHEMA_LOAD_ERRORS.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>b0e960ddac4d43a3860e8a06dfe09e03</uuid><name>TiDB: Load schema total, rate</name><type>DEPENDENT</type><key>tidb.domain_load_schema.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The statistics of the schemas that TiDB obtains from TiKV per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_domain_load_schema_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>domain</value></tag></tags></item><item><uuid>8fffe502bd2f42368e60d2110f1c3319</uuid><name>TiDB: Failed Query, rate</name><type>DEPENDENT</type><key>tidb.execute_error.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of error occurred when executing SQL statements per second (such as syntax errors and primary key conflicts).</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_server_execute_error_total&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>sql</value></tag></tags></item><item><uuid>954f5e433a7c44128d7772b87d493270</uuid><name>TiDB: Get instance metrics</name><type>HTTP_AGENT</type><key>tidb.get_metrics</key><history>0</history><trends>0</trends><value_type>TEXT</value_type><description>Get TiDB instance metrics.</description><preprocessing><step><type>CHECK_NOT_SUPPORTED</type><parameters><parameter/></parameters></step><step><type>PROMETHEUS_TO_JSON</type><parameters><parameter/></parameters></step></preprocessing><url>{$TIDB.URL}:{$TIDB.PORT}/metrics</url><tags><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>e95ebe1050b8404f8274e243203fdecc</uuid><name>TiDB: Get instance status</name><type>HTTP_AGENT</type><key>tidb.get_status</key><history>0</history><trends>0</trends><value_type>TEXT</value_type><description>Get TiDB instance status info.</description><preprocessing><step><type>CHECK_NOT_SUPPORTED</type><parameters><parameter/></parameters><error_handler>CUSTOM_VALUE</error_handler><error_handler_params>{&quot;status&quot;: &quot;0&quot;}</error_handler_params></step></preprocessing><url>{$TIDB.URL}:{$TIDB.PORT}/status</url><tags><tag><tag>component</tag><value>health</value></tag><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>14cf8296365048a59fd42f03966b1e1e</uuid><name>TiDB: Goroutine count</name><type>DEPENDENT</type><key>tidb.goroutines</key><delay>0</delay><history>7d</history><description>The number of Goroutines on TiDB instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;go_goroutines&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>goroutines</value></tag></tags></item><item><uuid>78e60bd44e3e4a4a859705c94ef94420</uuid><name>TiDB: Heap memory usage</name><type>DEPENDENT</type><key>tidb.heap_bytes</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>Number of heap bytes that are in use.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;go_memstats_heap_inuse_bytes&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>memory</value></tag></tags><triggers><trigger><uuid>575a4821ed8c4a1881b7f9bd264b1929</uuid><expression>min(/TiDB by HTTP/tidb.heap_bytes,5m)&gt;{$TIDB.HEAP.USAGE.MAX.WARN}</expression><name>TiDB: Heap memory usage is too high</name><event_name>TiDB: Heap memory usage is too high (over {$TIDB.HEAP.USAGE.MAX.WARN} for 5m)</event_name><priority>WARNING</priority><tags><tag><tag>scope</tag><value>capacity</value></tag></tags></trigger></triggers></item><item><uuid>104c09cb47f640fb804c136a09aa3bd2</uuid><name>TiDB: Keep alive, rate</name><type>DEPENDENT</type><key>tidb.monitor_keep_alive.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of times that the metrics are refreshed on TiDB instance per minute.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_monitor_keep_alive_total&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>SIMPLE_CHANGE</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>health</value></tag></tags><triggers><trigger><uuid>eb3c09904fa843d78401b00eff4f6a08</uuid><expression>max(/TiDB by HTTP/tidb.monitor_keep_alive.rate,5m)&lt;{$TIDB.MONITOR_KEEP_ALIVE.MAX.WARN}</expression><name>TiDB: Too few keep alive operations</name><event_name>TiDB: Too few keep alive operations (less {$TIDB.MONITOR_KEEP_ALIVE.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><description>Indicates whether the TiDB process still exists. If the number of times for tidb_monitor_keep_alive_total increases less than 10 per minute, the TiDB process might already exit and an alert is triggered.</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>d3ef55b9fd8b4a2aa1cbbc48f15203cb</uuid><name>TiDB: Time jump back, rate</name><type>DEPENDENT</type><key>tidb.monitor_time_jump_back.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of times that the operating system rewinds every second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_monitor_time_jump_back_total&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>application</value></tag></tags><triggers><trigger><uuid>c3c1f6eab224453b92534d5393aca2b7</uuid><expression>min(/TiDB by HTTP/tidb.monitor_time_jump_back.rate,5m)&gt;{$TIDB.TIME_JUMP_BACK.MAX.WARN}</expression><name>TiDB: Too many time jump backs</name><event_name>TiDB: Too many time jump backs (over {$TIDB.TIME_JUMP_BACK.MAX.WARN} for 5m)</event_name><priority>WARNING</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item><item><uuid>dce76be0ccbe44969bb09ad29d599790</uuid><name>TiDB: PD TSO commands, rate</name><type>DEPENDENT</type><key>tidb.pd_tso_cmd.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of TSO commands that TiDB obtains from PD per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;pd_client_cmd_handle_cmds_duration_seconds_count&quot; &amp;&amp; @.labels.type == &quot;tso&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>pd-commands</value></tag></tags></item><item><uuid>2bde50849f5541c3ac8aa5b26f5b8b52</uuid><name>TiDB: PD TSO requests, rate</name><type>DEPENDENT</type><key>tidb.pd_tso_request.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of TSO requests that TiDB obtains from PD per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;pd_client_request_handle_requests_duration_seconds_count&quot; &amp;&amp; @.labels.type == &quot;tso&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>pd-commands</value></tag></tags></item><item><uuid>ad8764623b8e46238efc0a94f0766a5b</uuid><name>TiDB: Open file descriptors, max</name><type>DEPENDENT</type><key>tidb.process_max_fds</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Maximum number of open file descriptors.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_max_fds&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>fds</value></tag></tags></item><item><uuid>04b3d6bf810c449db1e4b79be6b263a9</uuid><name>TiDB: Open file descriptors</name><type>DEPENDENT</type><key>tidb.process_open_fds</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Number of open file descriptors.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_open_fds&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>fds</value></tag></tags></item><item><uuid>fbee374d0fda4679a693ccccc26e5713</uuid><name>TiDB: RSS memory usage</name><type>DEPENDENT</type><key>tidb.rss_bytes</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>Resident memory size in bytes.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_resident_memory_bytes&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>memory</value></tag></tags></item><item><uuid>651140aae7334994a31d24568c08a9ab</uuid><name>TiDB: Total &quot;error&quot; server query, rate</name><type>DEPENDENT</type><key>tidb.server_query.error.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Qps</units><description>The number of queries on TiDB instance per second with failure of command execution results.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tidb_server_query_total&quot; &amp;&amp; @.labels.result == &quot;Error&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag></tags></item><item><uuid>00374eab11a14ab1b4e636996519ab80</uuid><name>TiDB: Total &quot;ok&quot; server query, rate</name><type>DEPENDENT</type><key>tidb.server_query.ok.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Qps</units><description>The number of queries on TiDB instance per second with success of command execution results.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tidb_server_query_total&quot; &amp;&amp; @.labels.result == &quot;OK&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag></tags></item><item><uuid>938e7bb83c714e198db55f3bb009daaf</uuid><name>TiDB: Total server query, rate</name><type>DEPENDENT</type><key>tidb.server_query.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Qps</units><description>The number of queries per second on TiDB instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tidb_server_query_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag></tags></item><item><uuid>84824ff459b74679b33e34a1f1e8cc69</uuid><name>TiDB: Schema lease &quot;change&quot; errors, rate</name><type>DEPENDENT</type><key>tidb.session_schema_lease_error.change.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of schema lease errors per second.
&quot;change&quot; means that the schema has changed</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_session_schema_lease_error_total &amp;&amp; @.labels.type == &quot;change&quot;&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>sessions</value></tag></tags></item><item><uuid>fe35df7cc7de4b0b8d616b042da99d69</uuid><name>TiDB: Schema lease &quot;outdate&quot; errors , rate</name><type>DEPENDENT</type><key>tidb.session_schema_lease_error.outdate.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of schema lease errors per second.
&quot;outdate&quot; errors means that the schema cannot be updated, which is a more serious error and triggers an alert.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_session_schema_lease_error_total &amp;&amp; @.labels.type == &quot;outdate&quot;&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>sessions</value></tag></tags><triggers><trigger><uuid>b077eb1afe6a4da79707987324fb40c8</uuid><expression>min(/TiDB by HTTP/tidb.session_schema_lease_error.outdate.rate,5m)&gt;{$TIDB.SCHEMA_LEASE_ERRORS.MAX.WARN}</expression><name>TiDB: Too many schema lease errors</name><event_name>TiDB: Too many schema lease errors (over {$TIDB.SCHEMA_LEASE_ERRORS.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><description>The latest schema information is not reloaded in TiDB within one lease.</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>fe8cf5e5c7704db797e76fd9d64e6d17</uuid><name>TiDB: SQL statements, rate</name><type>DEPENDENT</type><key>tidb.statement_total.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The total number of SQL statements executed per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_executor_statement_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>sql</value></tag></tags></item><item><uuid>ed86585a496b4b438c521c4765d76b11</uuid><name>TiDB: Status</name><type>DEPENDENT</type><key>tidb.status</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>CHAR</value_type><description>Status of PD instance.</description><valuemap><name>Service state</name></valuemap><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.status</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler><error_handler_params>1</error_handler_params></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>tidb.get_status</key></master_item><tags><tag><tag>component</tag><value>health</value></tag></tags><triggers><trigger><uuid>82a638ac4a3f4b349ee7bb0d53bc1f29</uuid><expression>last(/TiDB by HTTP/tidb.status)=0</expression><name>TiDB: Instance is not responding</name><priority>AVERAGE</priority><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>b5db09e71f2341b8ac1b9e48cbdefc82</uuid><name>TiDB: Server connections</name><type>DEPENDENT</type><key>tidb.tidb_server_connections</key><delay>0</delay><history>7d</history><description>The connection number of current TiDB instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_server_connections&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>connections</value></tag></tags></item><item><uuid>73992d4be61e443eafcc03aaa1bbf4a5</uuid><name>TiDB: Server critical error, rate</name><type>DEPENDENT</type><key>tidb.tidb_server_critical_error_total.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of critical errors occurred in TiDB per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_server_critical_error_total&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>server</value></tag></tags></item><item><uuid>f1e2436ced3c456a85650e0622715777</uuid><name>TiDB: Server panic, rate</name><type>DEPENDENT</type><key>tidb.tidb_server_panic_total.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of panics occurred in TiDB per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_server_panic_total&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>server</value></tag></tags><triggers><trigger><uuid>c457465731c947eab7b477186d8ba876</uuid><expression>last(/TiDB by HTTP/tidb.tidb_server_panic_total.rate)&gt;0</expression><name>TiDB: There are panicked TiDB threads</name><priority>AVERAGE</priority><description>When a panic occurs, an alert is triggered. The thread is often recovered, otherwise, TiDB will frequently restart.</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>8a63b326356f4fdbb9cb6e73437348be</uuid><name>TiDB: KV backoff, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_backoff.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of errors returned by TiKV.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_backoff_total&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>tikv-commands</value></tag></tags></item><item><uuid>aef7cdfd07f1420c970f20c821fed8dd</uuid><name>TiDB: Lock resolves, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_lock_resolver_action.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of DDL tasks that are waiting.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_lock_resolver_actions_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>tikv-commands</value></tag></tags></item><item><uuid>c116313e63fa45d89bf44772cc9cb3b8</uuid><name>TiDB: TiClient region errors, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_region_err.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of region related errors returned by TiKV per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_region_err_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>regions</value></tag></tags><triggers><trigger><uuid>d3cb81c46e414ff2a7e411a877b899ef</uuid><expression>min(/TiDB by HTTP/tidb.tikvclient_region_err.rate,5m)&gt;{$TIDB.REGION_ERROR.MAX.WARN}</expression><name>TiDB: Too many region related errors</name><event_name>TiDB: Too many region related errors (over {$TIDB.REGION_ERROR.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item><item><uuid>8ddf164df8c9404ba9f7c0f87db3bc2f</uuid><name>TiDB: KV commands, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_txn.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of executed KV commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_txn_cmd_duration_seconds_count&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>tikv-commands</value></tag></tags></item><item><uuid>20c0fffd66c84a16bb4d8f7882c896bc</uuid><name>TiDB: Uptime</name><type>DEPENDENT</type><key>tidb.uptime</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>uptime</units><description>The runtime of each TiDB instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_start_time_seconds&quot;)].value.first()</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>//use boottime to calculate uptime
return (Math.floor(Date.now()/1000)-Number(value));</parameter></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>application</value></tag></tags><triggers><trigger><uuid>91adc4c6b9364693891faf58c8cced75</uuid><expression>last(/TiDB by HTTP/tidb.uptime)&lt;10m</expression><name>TiDB: has been restarted</name><event_name>TiDB: has been restarted (uptime &lt; 10m)</event_name><priority>INFO</priority><description>Uptime is less than 10 minutes</description><manual_close>YES</manual_close><tags><tag><tag>scope</tag><value>notice</value></tag></tags></trigger></triggers></item><item><uuid>65fa2b077073467387b39bef035b0644</uuid><name>TiDB: Version</name><type>DEPENDENT</type><key>tidb.version</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>CHAR</value_type><description>Version of the TiDB instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.version</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>3h</parameter></parameters></step></preprocessing><master_item><key>tidb.get_status</key></master_item><tags><tag><tag>component</tag><value>application</value></tag></tags><triggers><trigger><uuid>5f863fc0944848fdad145f42c94dbea3</uuid><expression>last(/TiDB by HTTP/tidb.version,#1)&lt;&gt;last(/TiDB by HTTP/tidb.version,#2) and length(last(/TiDB by HTTP/tidb.version))&gt;0</expression><name>TiDB: Version has changed</name><event_name>TiDB: Version has changed (new version: {ITEM.VALUE})</event_name><priority>INFO</priority><description>TiDB version has changed. Ack to close.</description><manual_close>YES</manual_close><tags><tag><tag>scope</tag><value>notice</value></tag></tags></trigger></triggers></item></items><discovery_rules><discovery_rule><uuid>4db735b652eb451d911f6dc01de6b1ba</uuid><name>KV metrics discovery</name><type>DEPENDENT</type><key>tidb.kv_ops.discovery</key><delay>0</delay><description>Discovery KV specific metrics.</description><item_prototypes><item_prototype><uuid>79b0a13b25c745d288c313c4197f2e5c</uuid><name>TiDB: KV Commands: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_txn.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of executed KV commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_txn_cmd_duration_seconds_count&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>tikv-commands</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_txn_cmd_duration_seconds_count&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>bcaf700328b94b59b35cf5bfaf27d5ac</uuid><name>QPS metrics discovery</name><type>DEPENDENT</type><key>tidb.qps.discovery</key><delay>0</delay><description>Discovery QPS specific metrics.</description><item_prototypes><item_prototype><uuid>3b450f5a853247358a8fe6f31f000575</uuid><name>TiDB: Server query &quot;Error&quot;: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.server_query.error.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Qps</units><description>The number of queries on TiDB instance per second with failure of command execution results.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tidb_server_query_total&quot; &amp;&amp; @.labels.result == &quot;Error&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype><item_prototype><uuid>125bdd3eb1b643f4ad00d58fbed455f6</uuid><name>TiDB: Server query &quot;OK&quot;: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.server_query.ok.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Qps</units><description>The number of queries on TiDB instance per second with success of command execution results.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tidb_server_query_total&quot; &amp;&amp; @.labels.result == &quot;OK&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_server_query_total&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>var lookup = {},
    result = [];

JSON.parse(value).forEach(function (item) {
    var type = item.labels.type;
    if (!(lookup[type])) {
        lookup[type] = 1;
        result.push({ &quot;{#TYPE}&quot;: type });
    }
})

return JSON.stringify(result);</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>e3c23b94a9514389b37e3911f79db8f8</uuid><name>Statement metrics discovery</name><type>DEPENDENT</type><key>tidb.statement.discover</key><delay>0</delay><description>Discovery statement specific metrics.</description><item_prototypes><item_prototype><uuid>111ffa26edd247eb9325f5ab5f5f3f94</uuid><name>TiDB: SQL statements: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.statement.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The number of SQL statements executed per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_executor_statement_total&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>sql</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_executor_statement_total&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>f9af6d56e612459583a1f5d3b4a7d61b</uuid><name>KV backoff discovery</name><type>DEPENDENT</type><key>tidb.tikvclient_backoff.discovery</key><delay>0</delay><description>Discovery KV backoff specific metrics.</description><item_prototypes><item_prototype><uuid>a11cf69675654e7ca70dbab255509bb8</uuid><name>TiDB: KV backoff: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_backoff.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_backoff_total&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>tikv-backoff</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_backoff_total&quot;)]</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>72d1f090ce9c4f89b06e4195989e4b2b</uuid><name>GC action results discovery</name><type>DEPENDENT</type><key>tidb.tikvclient_gc_action.discovery</key><delay>0</delay><description>Discovery GC action results metrics.</description><item_prototypes><item_prototype><uuid>e3c19674dcdf4fdea1f8cd82e3df9f72</uuid><name>TiDB: GC action result: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_gc_action.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of results of GC-related operations per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_gc_action_result&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>gc</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags><trigger_prototypes><trigger_prototype><uuid>2d24956d0a4f459fad155590376696c1</uuid><expression>min(/TiDB by HTTP/tidb.tikvclient_gc_action.rate[{#TYPE}],5m)&gt;{$TIDB.GC_ACTIONS.ERRORS.MAX.WARN}</expression><name>TiDB: Too many failed GC-related operations</name><event_name>TiDB: Too many failed GC-related operations (over {$TIDB.GC_ACTIONS.ERRORS.MAX.WARN} in 5m)</event_name><discover>NO_DISCOVER</discover><priority>WARNING</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger_prototype></trigger_prototypes></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_gc_action_result&quot;)]</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><overrides><override><name>Failed GC-related operations trigger</name><step>1</step><filter><conditions><condition><macro>{#TYPE}</macro><value>failed</value><formulaid>A</formulaid></condition></conditions></filter><operations><operation><operationobject>TRIGGER_PROTOTYPE</operationobject><operator>LIKE</operator><value>Too many failed GC-related operations</value><status>ENABLED</status><discover>DISCOVER</discover></operation></operations></override></overrides></discovery_rule><discovery_rule><uuid>a4f2e1902cc54f0db9e9c345c63285e2</uuid><name>Lock resolves discovery</name><type>DEPENDENT</type><key>tidb.tikvclient_lock_resolver_action.discovery</key><delay>0</delay><description>Discovery lock resolves specific metrics.</description><item_prototypes><item_prototype><uuid>2eebf2ccc44a4cadb0b70e153b70b3a2</uuid><name>TiDB: Lock resolves: {#TYPE}, rate</name><type>DEPENDENT</type><key>tidb.tikvclient_lock_resolver_action.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_lock_resolver_actions_total&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tidb.get_metrics</key></master_item><tags><tag><tag>component</tag><value>locks</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tidb.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;tidb_tikvclient_lock_resolver_actions_total&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule></discovery_rules><tags><tag><tag>class</tag><value>database</value></tag><tag><tag>target</tag><value>tidb</value></tag></tags><macros><macro><macro>{$TIDB.DDL.WAITING.MAX.WARN}</macro><value>5</value><description>Maximum number of DDL tasks that are waiting</description></macro><macro><macro>{$TIDB.GC_ACTIONS.ERRORS.MAX.WARN}</macro><value>1</value><description>Maximum number of GC-related operations failures</description></macro><macro><macro>{$TIDB.HEAP.USAGE.MAX.WARN}</macro><value>10G</value><description>Maximum heap memory used</description></macro><macro><macro>{$TIDB.MONITOR_KEEP_ALIVE.MAX.WARN}</macro><value>10</value><description>Minimum number of keep alive operations</description></macro><macro><macro>{$TIDB.OPEN.FDS.MAX.WARN}</macro><value>90</value><description>Maximum percentage of used file descriptors</description></macro><macro><macro>{$TIDB.PORT}</macro><value>10080</value><description>The port of TiDB server metrics web endpoint</description></macro><macro><macro>{$TIDB.REGION_ERROR.MAX.WARN}</macro><value>50</value><description>Maximum number of region related errors</description></macro><macro><macro>{$TIDB.SCHEMA_LEASE_ERRORS.MAX.WARN}</macro><value>0</value><description>Maximum number of schema lease errors</description></macro><macro><macro>{$TIDB.SCHEMA_LOAD_ERRORS.MAX.WARN}</macro><value>1</value><description>Maximum number of load schema errors</description></macro><macro><macro>{$TIDB.TIME_JUMP_BACK.MAX.WARN}</macro><value>1</value><description>Maximum number of times that the operating system rewinds every second</description></macro><macro><macro>{$TIDB.URL}</macro><value>localhost</value><description>TiDB server URL</description></macro></macros><valuemaps><valuemap><uuid>047f0303f1bc424a959f5d0ceaab77c7</uuid><name>Service state</name><mappings><mapping><value>0</value><newvalue>Down</newvalue></mapping><mapping><value>1</value><newvalue>Up</newvalue></mapping></mappings></valuemap></valuemaps></template></templates><triggers><trigger><uuid>cfd6ba0dbf294b9e9ab6afc7d44be7b3</uuid><expression>min(/TiDB by HTTP/tidb.process_open_fds,5m)/last(/TiDB by HTTP/tidb.process_max_fds)*100&gt;{$TIDB.OPEN.FDS.MAX.WARN}</expression><name>TiDB: Current number of open files is too high</name><event_name>TiDB: Current number of open files is too high (over {$TIDB.OPEN.FDS.MAX.WARN}% for 5m)</event_name><priority>WARNING</priority><description>Heavy file descriptor usage (i.e., near the process's file descriptor limit) indicates a potential file descriptor exhaustion issue.</description><tags><tag><tag>scope</tag><value>capacity</value></tag></tags></trigger></triggers><graphs><graph><uuid>ee25671d0b5446348341be56967a74b2</uuid><name>TiDB: File descriptors</name><graph_items><graph_item><drawtype>GRADIENT_LINE</drawtype><color>1A7C11</color><item><host>TiDB by HTTP</host><key>tidb.process_open_fds</key></item></graph_item><graph_item><sortorder>1</sortorder><drawtype>BOLD_LINE</drawtype><color>2774A4</color><item><host>TiDB by HTTP</host><key>tidb.process_max_fds</key></item></graph_item></graph_items></graph><graph><uuid>fb29a5ea3a62416f8eeee804a6f83c46</uuid><name>TiDB: Memory usage</name><graph_items><graph_item><color>1A7C11</color><item><host>TiDB by HTTP</host><key>tidb.heap_bytes</key></item></graph_item><graph_item><sortorder>1</sortorder><color>2774A4</color><item><host>TiDB by HTTP</host><key>tidb.rss_bytes</key></item></graph_item></graph_items></graph><graph><uuid>5ab746ad86ef4710948263d4d6157742</uuid><name>TiDB: Server query rate</name><graph_items><graph_item><color>1A7C11</color><item><host>TiDB by HTTP</host><key>tidb.server_query.rate</key></item></graph_item><graph_item><sortorder>1</sortorder><color>2774A4</color><item><host>TiDB by HTTP</host><key>tidb.server_query.ok.rate</key></item></graph_item><graph_item><sortorder>2</sortorder><color>F63100</color><item><host>TiDB by HTTP</host><key>tidb.server_query.error.rate</key></item></graph_item></graph_items></graph></graphs></zabbix_export>
