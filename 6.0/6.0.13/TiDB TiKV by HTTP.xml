<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>6.0</version><date>2023-02-11T16:14:53Z</date><groups><group><uuid>748ad4d098d447d492bb935c907f652f</uuid><name>Templates/Databases</name></group></groups><templates><template><uuid>3a0bbbb2ec0a4c58bba3ba3a3d6ce660</uuid><template>TiDB TiKV by HTTP</template><name>TiDB TiKV by HTTP</name><description>The template to monitor TiKV server of TiDB cluster by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.
Don't forget to change the macros {$TIKV.URL}, {$TIKV.PORT}.

Template `TiDB TiKV by HTTP` â€” collects metrics by HTTP agent from TiKV /metrics endpoint.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Template tooling version used: 0.41</description><groups><group><name>Templates/Databases</name></group></groups><items><item><uuid>449a7ba908884db3af4ec8ccc0d7ea43</uuid><name>TiKV: Scheduler: High priority commands total, rate</name><type>DEPENDENT</type><key>tikv.commands_pri.high.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total count of high priority commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_commands_pri_total&quot; &amp;&amp; @.labels.priority == &quot;high&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags></item><item><uuid>b5ce79ee79804e76bb7b91e17915159c</uuid><name>TiKV: Scheduler: Low priority commands total, rate</name><type>DEPENDENT</type><key>tikv.commands_pri.low.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total count of low priority commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_commands_pri_total&quot; &amp;&amp; @.labels.priority == &quot;low&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags></item><item><uuid>df3fa02457ac47168fad251727b300ff</uuid><name>TiKV: Scheduler: Normal priority commands total, rate</name><type>DEPENDENT</type><key>tikv.commands_pri.normal.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total count of normal priority commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_commands_pri_total&quot; &amp;&amp; @.labels.priority == &quot;normal&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags></item><item><uuid>dbf8288b5cab4e8a95b5e7c4355676bd</uuid><name>TiKV: Coprocessor: Requests, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_request.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of coprocessor requests per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_request_duration_seconds_count&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag></tags></item><item><uuid>d6185382a1974b9194e68bea4f14eb75</uuid><name>TiKV: Coprocessor: Errors, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_request_error.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of push down request error per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_request_error&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag></tags><triggers><trigger><uuid>31eca27ff6ce4ed78ee428ed3b8d8806</uuid><expression>min(/TiDB TiKV by HTTP/tikv.coprocessor_request_error.rate,5m)&gt;{$TIKV.COPOCESSOR.ERRORS.MAX.WARN}</expression><name>TiKV: Too many coprocessor request error</name><event_name>TiKV: Too many coprocessor request error (over {$TIKV.COPOCESSOR.ERRORS.MAX.WARN} in 5m)</event_name><priority>WARNING</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item><item><uuid>5567ebf02fb6441dbb6672e1bc77b3ab</uuid><name>TiKV: Coprocessor: Response size, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_response_bytes.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Bps</units><description>The total size of coprocessor response per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_response_bytes&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag></tags></item><item><uuid>237f6ba2973e472d8c20de1d61b4695c</uuid><name>TiKV: Coprocessor: RocksDB ops, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_rocksdb_perf.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of RocksDB internal operations from PerfContext per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_rocksdb_perf&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag></tags></item><item><uuid>bfcec759c0894cf89c5267fc6b3862d7</uuid><name>TiKV: Coprocessor: Scan keys, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_scan_keys_sum.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of scan keys observed per request per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_scan_keys&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag></tags></item><item><uuid>a76665b7a9924f8cbd4a455bc248d790</uuid><name>TiKV: CPU util</name><type>DEPENDENT</type><key>tikv.cpu.util</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>%</units><description>The CPU usage ratio on TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_thread_cpu_seconds_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step><step><type>MULTIPLIER</type><parameters><parameter>100</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>cpu</value></tag></tags></item><item><uuid>4558a5a11c304584bf24a7c3d2eace23</uuid><name>TiKV: Bytes read</name><type>DEPENDENT</type><key>tikv.engine_flow_bytes.read</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Bps</units><description>The total bytes of read in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_engine_flow_bytes&quot; &amp;&amp; @.labels.db == &quot;kv&quot; &amp;&amp; @.labels.type =~ &quot;bytes_read|iter_bytes_read&quot;)].value.sum()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>0d44c3c9a7f34905b0404ae39a3bc881</uuid><name>TiKV: Bytes write</name><type>DEPENDENT</type><key>tikv.engine_flow_bytes.write</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Bps</units><description>The total bytes of write in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_engine_flow_bytes&quot; &amp;&amp; @.labels.db == &quot;kv&quot; &amp;&amp; @.labels.type == &quot;wal_file_bytes&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>f79d5daea61842b18e39c7289657ddf5</uuid><name>TiKV: Store size</name><type>DEPENDENT</type><key>tikv.engine_size</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The storage size of TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_engine_size_bytes&quot;)].value.sum()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>418bcc8c0bc440468efe833bef02929d</uuid><name>TiKV: Get instance metrics</name><type>HTTP_AGENT</type><key>tikv.get_metrics</key><history>0</history><trends>0</trends><value_type>TEXT</value_type><description>Get TiKV instance metrics.</description><preprocessing><step><type>CHECK_NOT_SUPPORTED</type><parameters><parameter/></parameters></step><step><type>PROMETHEUS_TO_JSON</type><parameters><parameter/></parameters></step></preprocessing><url>{$TIKV.URL}:{$TIKV.PORT}/metrics</url><tags><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>fed3db7222fa41a8bf51d2ad860a22d4</uuid><name>TiKV: Total query, rate</name><type>DEPENDENT</type><key>tikv.grpc_msg.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The total QPS in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_grpc_msg_duration_seconds_count&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>queries</value></tag></tags></item><item><uuid>c68db41c184d44d98445cc66489ef39c</uuid><name>TiKV: Total query errors, rate</name><type>DEPENDENT</type><key>tikv.grpc_msg_fail.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The total number of gRPC message handling failure per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_grpc_msg_fail_total&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>grpc</value></tag></tags></item><item><uuid>7afa5147a1e247a5b8914d8739d31f15</uuid><name>TiKV: Server: failure messages total, rate</name><type>DEPENDENT</type><key>tikv.messages.failure.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total number of reporting failure messages per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_server_report_failure_msg_total&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>application</value></tag></tags></item><item><uuid>e6137dd87faa496497b23cadaa37dca9</uuid><name>TiKV: Regions, count</name><type>DEPENDENT</type><key>tikv.region_count</key><delay>0</delay><history>7d</history><description>The number of regions collected in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_raftstore_region_count&quot; &amp;&amp; @.labels.type == &quot;region&quot; )].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>regions</value></tag></tags></item><item><uuid>2ab7643435794ec6b5a2c3eb1dd7e913</uuid><name>TiKV: Regions, leader</name><type>DEPENDENT</type><key>tikv.region_leader</key><delay>0</delay><history>7d</history><description>The number of leaders in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_raftstore_region_count&quot; &amp;&amp; @.labels.type == &quot;leader&quot; )].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>regions</value></tag></tags></item><item><uuid>1c480fa23eaa42bcb367bb5afdcb65b9</uuid><name>TiKV: RSS memory usage</name><type>DEPENDENT</type><key>tikv.rss_bytes</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>Resident memory size in bytes.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;process_resident_memory_bytes&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>memory</value></tag></tags></item><item><uuid>62f856cf22804262aef64e9369049332</uuid><name>TiKV: Scheduler: Commands total, rate</name><type>DEPENDENT</type><key>tikv.scheduler_commands.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total number of commands per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_stage_total&quot;)].value.sum()</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler><error_handler_params>0</error_handler_params></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags></item><item><uuid>33a1b2f676134cf1b81771fbaf152f59</uuid><name>TiKV: Scheduler: Pending commands</name><type>DEPENDENT</type><key>tikv.scheduler_contex</key><delay>0</delay><history>7d</history><description>The total number of pending commands. The scheduler receives commands from clients, executes them against the MVCC layer storage engine.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_contex_total&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags><triggers><trigger><uuid>0f21c02b8e1c45d9bbe0c3313cea1a23</uuid><expression>min(/TiDB TiKV by HTTP/tikv.scheduler_contex,5m)&gt;{$TIKV.PENDING_COMMANDS.MAX.WARN}</expression><name>TiKV: Too many pending commands</name><event_name>TiKV: Too many pending commands (over {$TIKV.PENDING_COMMANDS.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item><item><uuid>8f5c9d2b9eca4a489d764420ee06e4b6</uuid><name>TiKV: Scheduler: Busy, rate</name><type>DEPENDENT</type><key>tikv.scheduler_too_busy.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>The total count of too busy schedulers per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_too_busy_total&quot;)].value.sum()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag></tags></item><item><uuid>0a2d0a119bcd406aadfc5c014186c5d3</uuid><name>TiKV: Snapshot: Applying</name><type>DEPENDENT</type><key>tikv.snapshot.applying</key><delay>0</delay><history>7d</history><description>The total amount of raftstore snapshot traffic.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_raftstore_snapshot_traffic_total&quot; &amp;&amp; @.labels.type == &quot;applying&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>snapshot</value></tag></tags></item><item><uuid>58559be859d64887a1b919e36aa1e336</uuid><name>TiKV: Snapshot: Receiving</name><type>DEPENDENT</type><key>tikv.snapshot.receiving</key><delay>0</delay><history>7d</history><description>The total amount of raftstore snapshot traffic.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_raftstore_snapshot_traffic_total&quot; &amp;&amp; @.labels.type == &quot;receiving&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>snapshot</value></tag></tags></item><item><uuid>0ae6a2024ed3488498e22bc542d27619</uuid><name>TiKV: Snapshot: Sending</name><type>DEPENDENT</type><key>tikv.snapshot.sending</key><delay>0</delay><history>7d</history><description>The total amount of raftstore snapshot traffic.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_raftstore_snapshot_traffic_total&quot; &amp;&amp; @.labels.type == &quot;sending&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>snapshot</value></tag></tags></item><item><uuid>ce31318a420d40668e62a47fe19d3d40</uuid><name>TiKV: Storage: commands total, rate</name><type>DEPENDENT</type><key>tikv.storage_command.rate</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total number of commands received per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_storage_command_total&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>commands</value></tag></tags></item><item><uuid>fbfaa0d967c049c0a1bbcec5afea4bf2</uuid><name>TiKV: Available size</name><type>DEPENDENT</type><key>tikv.store_size.available</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The available capacity of TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_store_size_bytes&quot; &amp;&amp; @.labels.type == &quot;available&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>1e0c1c071b604e77998797c2f9d41dfc</uuid><name>TiKV: Capacity size</name><type>DEPENDENT</type><key>tikv.store_size.capacity</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>The capacity size of TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_store_size_bytes&quot; &amp;&amp; @.labels.type == &quot;capacity&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>storage</value></tag></tags></item><item><uuid>f2632dbd773140398a7d61608d85f392</uuid><name>TiKV: Uptime</name><type>DEPENDENT</type><key>tikv.uptime</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>uptime</units><description>The runtime of each TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name==&quot;process_start_time_seconds&quot;)].value.first()</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>//use boottime to calculate uptime
return (Math.floor(Date.now()/1000)-Number(value));</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>application</value></tag></tags><triggers><trigger><uuid>ca06602fa0b64a2ba0c51ed4835c52b2</uuid><expression>last(/TiDB TiKV by HTTP/tikv.uptime)&lt;10m</expression><name>TiKV: has been restarted</name><event_name>TiKV: has been restarted (uptime &lt; 10m)</event_name><priority>INFO</priority><description>Uptime is less than 10 minutes</description><manual_close>YES</manual_close><tags><tag><tag>scope</tag><value>notice</value></tag></tags></trigger></triggers></item><item><uuid>8b7c2dc8c60e491db76cafd2d0e1234b</uuid><name>TiKV: Snapshot: Pending tasks</name><type>DEPENDENT</type><key>tikv.worker_pending_task</key><delay>0</delay><history>7d</history><description>The number of tasks currently running by the worker or pending.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_worker_pending_task_total&quot;)].value.first()</parameter></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>snapshot</value></tag></tags><triggers><trigger><uuid>f26874f910e34933983685ae43a90bee</uuid><expression>min(/TiDB TiKV by HTTP/tikv.worker_pending_task,5m)&gt;{$TIKV.PENDING_TASKS.MAX.WARN}</expression><name>TiKV: Too many pending tasks</name><event_name>TiKV: Too many pending tasks (over {$TIKV.PENDING_TASKS.MAX.WARN} for 5m)</event_name><priority>AVERAGE</priority><tags><tag><tag>scope</tag><value>performance</value></tag></tags></trigger></triggers></item></items><discovery_rules><discovery_rule><uuid>f1c7de94679e40a4ac6f569e05ad61d0</uuid><name>Coprocessor metrics discovery</name><type>DEPENDENT</type><key>tikv.coprocessor.discovery</key><delay>0</delay><description>Discovery coprocessor metrics.</description><item_prototypes><item_prototype><uuid>ecbe08549fef42d5aad0369e861b4c20</uuid><name>TiKV: Coprocessor: {#REQ_TYPE} requests, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_request.rate[{#REQ_TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of coprocessor requests per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_request_duration_seconds_count&quot; &amp;&amp; @.labels.req == &quot;{#REQ_TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag><tag><tag>request</tag><value>{#REQ_TYPE}</value></tag></tags></item_prototype><item_prototype><uuid>08060401409b4fff97430c595fec7b82</uuid><name>TiKV: Coprocessor: {#REQ_TYPE} errors, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_request_error.rate[{#REQ_TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of push down request error per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_request_error&quot; &amp;&amp; @.labels.req == &quot;{#REQ_TYPE}&quot;)].value.first()</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag><tag><tag>request</tag><value>{#REQ_TYPE}</value></tag></tags></item_prototype><item_prototype><uuid>bff6ee970f7349edba6cac1cd0da70ed</uuid><name>TiKV: Coprocessor: {#REQ_TYPE} RocksDB ops, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_rocksdb_perf.rate[{#REQ_TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of RocksDB internal operations from PerfContext per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_rocksdb_perf&quot; &amp;&amp; @.labels.req == &quot;{#REQ_TYPE}&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag><tag><tag>request</tag><value>{#REQ_TYPE}</value></tag></tags></item_prototype><item_prototype><uuid>8ef93de8a25b4f35b2e54f6ced4a5bd2</uuid><name>TiKV: Coprocessor: {#REQ_TYPE} scan keys, rate</name><type>DEPENDENT</type><key>tikv.coprocessor_scan_keys.rate[{#REQ_TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>Total number of scan keys observed per request per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_scan_keys_count&quot; &amp;&amp; @.labels.req == &quot;{#REQ_TYPE}&quot;)].value.first()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>coprocessor</value></tag><tag><tag>request</tag><value>{#REQ_TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tikv.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_coprocessor_request_duration_seconds_count&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#REQ_TYPE}&quot;: item.labels.req,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>39e4031ee41143ed9d0c84492f817125</uuid><name>QPS metrics discovery</name><type>DEPENDENT</type><key>tikv.qps.discovery</key><delay>0</delay><description>Discovery QPS metrics.</description><item_prototypes><item_prototype><uuid>3b1d1b10cee6465c822152072189ebbe</uuid><name>TiKV: Query: {#TYPE}, rate</name><type>DEPENDENT</type><key>tikv.grpc_msg.rate[{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>Ops</units><description>The QPS per command in TiKV instance.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_grpc_msg_duration_seconds_count&quot; &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.first()</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>grpc</value></tag><tag><tag>type</tag><value>{#TYPE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tikv.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_grpc_msg_duration_seconds_count&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#TYPE}&quot;: item.labels.type,
     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>7168e631146546129284cbf9c52b2025</uuid><name>Scheduler metrics discovery</name><type>DEPENDENT</type><key>tikv.scheduler.discovery</key><delay>0</delay><description>Discovery scheduler metrics.</description><item_prototypes><item_prototype><uuid>c4f902a0be5444b2babb1775b89a6827</uuid><name>TiKV: Scheduler: commands {#STAGE}, rate</name><type>DEPENDENT</type><key>tikv.scheduler_stage.rate[{#STAGE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total number of commands on each stage per second.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_stage_total&quot; &amp;&amp; @.labels.stage == &quot;{#STAGE}&quot;)].value.sum()</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler><error_handler_params>0</error_handler_params></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>scheduler</value></tag><tag><tag>stage</tag><value>{#STAGE}</value></tag></tags></item_prototype></item_prototypes><master_item><key>tikv.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_scheduler_stage_total&quot;)]</parameter></parameters></step><step><type>JAVASCRIPT</type><parameters><parameter>var lookup = {},
    result = [];

JSON.parse(value).forEach(function (item) {
    var stage = item.labels.stage;
    if (!(lookup[stage])) {
        lookup[stage] = 1;
        result.push({ &quot;{#STAGE}&quot;: stage });
    }
})

return JSON.stringify(result);</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing></discovery_rule><discovery_rule><uuid>5ebd2e2131ab4a9f8ca63f0e490b04a3</uuid><name>Server errors discovery</name><type>DEPENDENT</type><key>tikv.server_report_failure.discovery</key><delay>0</delay><description>Discovery server errors metrics.</description><item_prototypes><item_prototype><uuid>064e74b5484e42e4acf3122c8ead4826</uuid><name>TiKV: Store_id {#STORE_ID}: failure messages &quot;{#TYPE}&quot;, rate</name><type>DEPENDENT</type><key>tikv.messages.failure.rate[{#STORE_ID},{#TYPE}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><description>Total number of reporting failure messages. The metric has two labels: type and store_id. type represents the failure type, and store_id represents the destination peer store id.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_server_report_failure_msg_total&quot; &amp;&amp; @.labels.store_id == &quot;{#STORE_ID}&quot;  &amp;&amp; @.labels.type == &quot;{#TYPE}&quot;)].value.sum()</parameter></parameters></step><step><type>CHANGE_PER_SECOND</type><parameters><parameter/></parameters></step></preprocessing><master_item><key>tikv.get_metrics</key></master_item><tags><tag><tag>component</tag><value>stores</value></tag><tag><tag>message-type</tag><value>{#TYPE}</value></tag><tag><tag>store</tag><value>{#STORE_ID}</value></tag></tags><trigger_prototypes><trigger_prototype><uuid>1f65b64824d64852aaa609df5f3e27fd</uuid><expression>min(/TiDB TiKV by HTTP/tikv.messages.failure.rate[{#STORE_ID},{#TYPE}],5m)&gt;{$TIKV.STORE.ERRORS.MAX.WARN}</expression><name>TiKV: Store_id {#STORE_ID}: Too many failure messages &quot;{#TYPE}&quot;</name><event_name>TiKV: Store_id {#STORE_ID}: Too many failure messages &quot;{#TYPE}&quot; (over {$TIKV.STORE.ERRORS.MAX.WARN} in 5m)</event_name><discover>NO_DISCOVER</discover><priority>WARNING</priority><description>Indicates that the remote TiKV cannot be connected.</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger_prototype></trigger_prototypes></item_prototype></item_prototypes><master_item><key>tikv.get_metrics</key></master_item><preprocessing><step><type>JSONPATH</type><parameters><parameter>$[?(@.name == &quot;tikv_server_report_failure_msg_total&quot;)]</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>JAVASCRIPT</type><parameters><parameter>output = JSON.parse(value).map(function(item){
     return {
         &quot;{#STORE_ID}&quot;: item.labels.store_id,
         &quot;{#TYPE}&quot;: item.labels.type,

     }})
 return JSON.stringify({&quot;data&quot;: output})</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><overrides><override><name>Too many unreachable messages trigger</name><step>1</step><filter><conditions><condition><macro>{#TYPE}</macro><value>unreachable</value><formulaid>A</formulaid></condition></conditions></filter><operations><operation><operationobject>TRIGGER_PROTOTYPE</operationobject><operator>LIKE</operator><value>Too many failure messages</value><status>ENABLED</status><discover>DISCOVER</discover></operation></operations></override></overrides></discovery_rule></discovery_rules><tags><tag><tag>class</tag><value>database</value></tag><tag><tag>target</tag><value>tidb</value></tag><tag><tag>target</tag><value>tikv</value></tag></tags><macros><macro><macro>{$TIKV.COPOCESSOR.ERRORS.MAX.WARN}</macro><value>1</value><description>Maximum number of coprocessor request errors</description></macro><macro><macro>{$TIKV.PENDING_COMMANDS.MAX.WARN}</macro><value>1</value><description>Maximum number of pending commands</description></macro><macro><macro>{$TIKV.PENDING_TASKS.MAX.WARN}</macro><value>1</value><description>Maximum number of tasks currently running by the worker or pending</description></macro><macro><macro>{$TIKV.PORT}</macro><value>20180</value><description>The port of TiKV server metrics web endpoint</description></macro><macro><macro>{$TIKV.STORE.ERRORS.MAX.WARN}</macro><value>1</value><description>Maximum number of failure messages</description></macro><macro><macro>{$TIKV.URL}</macro><value>localhost</value><description>TiKV server URL</description></macro></macros></template></templates><graphs><graph><uuid>cdca8a2bb2bb486da8c57740acc431d6</uuid><name>TiKV: Scheduler priority commands rate</name><graph_items><graph_item><color>1A7C11</color><item><host>TiDB TiKV by HTTP</host><key>tikv.commands_pri.normal.rate</key></item></graph_item><graph_item><sortorder>1</sortorder><color>2774A4</color><item><host>TiDB TiKV by HTTP</host><key>tikv.commands_pri.high.rate</key></item></graph_item><graph_item><sortorder>2</sortorder><color>F63100</color><item><host>TiDB TiKV by HTTP</host><key>tikv.commands_pri.low.rate</key></item></graph_item></graph_items></graph><graph><uuid>93a38153ed8b44a49849cb1f920f50a4</uuid><name>TiKV: Snapshot state count</name><graph_items><graph_item><color>1A7C11</color><item><host>TiDB TiKV by HTTP</host><key>tikv.snapshot.applying</key></item></graph_item><graph_item><sortorder>1</sortorder><color>2774A4</color><item><host>TiDB TiKV by HTTP</host><key>tikv.snapshot.receiving</key></item></graph_item><graph_item><sortorder>2</sortorder><color>F63100</color><item><host>TiDB TiKV by HTTP</host><key>tikv.snapshot.sending</key></item></graph_item></graph_items></graph></graphs></zabbix_export>
