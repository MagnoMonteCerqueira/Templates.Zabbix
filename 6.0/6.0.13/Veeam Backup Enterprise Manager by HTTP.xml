<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export><version>6.0</version><date>2023-02-11T16:15:12Z</date><groups><group><uuid>a571c0d144b14fd4a87a9d9b2aa9fcd6</uuid><name>Templates/Applications</name></group></groups><templates><template><uuid>2ce384bafd524db5b910d7f55bca1fbb</uuid><template>Veeam Backup Enterprise Manager by HTTP</template><name>Veeam Backup Enterprise Manager by HTTP</name><description>This template is designed to monitor Veeam Backup Enterprise Manager.
The Veeam Backup Enterprise Manager REST API enables the communication with Zabbix to query the information about Veeam Backup Enterprise Manager objects.
It works without any external scripts and uses the script item. 

Setup:
  1. Create a user to monitor the service, or use an existing read-only account.
     You can also obtain the collected jobs if you are logged in under an account having only `Portal Administrator` role.
  See [Veeam Help Center](https://helpcenter.veeam.com/docs/backup/em_rest/http_authentication.html?ver=110) for more details.
  2. Link the template to a host.
  3. Configure the following macros: `{$VEEAM.MANAGER.API.URL}`, `{$VEEAM.MANAGER.USER}`, `{$VEEAM.MANAGER.PASSWORD}`.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/

Template tooling version used: 0.41</description><groups><group><name>Templates/Applications</name></group></groups><items><item><uuid>a1b612cd8e274a27a834dbdb69fe7d08</uuid><name>Veeam Manager: Failed Job Runs</name><type>DEPENDENT</type><key>veeam.manager.failed.jobs</key><delay>0</delay><history>7d</history><description>Informs about the failed job runs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.FailedJobRuns</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags><triggers><trigger><uuid>4885d43f36b541219be87b5e5ea19088</uuid><expression>last(/Veeam Backup Enterprise Manager by HTTP/veeam.manager.failed.jobs)&gt;{$VEEAM.MANAGER.JOB.MAX.FAIL}</expression><name>Veeam Manager: Failed job runs is too high</name><event_name>Veeam Manager: Failed job runs is too high (over {$VEEAM.MANAGER.JOB.MAX.FAIL})</event_name><priority>AVERAGE</priority><manual_close>YES</manual_close><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>e698c05dae9f4d2f8323ce718e9ed83b</uuid><name>Veeam Manager: Get errors</name><type>DEPENDENT</type><key>veeam.manager.get.errors</key><delay>0</delay><history>7d</history><trends>0</trends><value_type>TEXT</value_type><description>The errors from API requests.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.error</parameter></parameters><error_handler>CUSTOM_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>status</value></tag></tags><triggers><trigger><uuid>83316e2168414042aeb9d98857534baa</uuid><expression>length(last(/Veeam Backup Enterprise Manager by HTTP/veeam.manager.get.errors))&gt;0</expression><name>Veeam Manager: There are errors in requests to API</name><opdata>{ITEM.LASTVALUE1}</opdata><priority>AVERAGE</priority><description>Zabbix has received errors in response to API requests.</description><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item><item><uuid>525a61ff4fb747efab6ac58d1ac8b7c4</uuid><name>Veeam Manager: Get metrics</name><type>SCRIPT</type><key>veeam.manager.get.metrics</key><delay>5m</delay><history>0d</history><trends>0</trends><value_type>TEXT</value_type><params>var Veeam = {
    params: {},

    setParams: function (params) {
        ['api_endpoint', 'user', 'password'].forEach(function (field) {
            if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
                throw 'Required param is not set: ' + field + '.';
            }
        });

        Veeam.params = params;
        if (typeof Veeam.params.api_endpoint === 'string' &amp;&amp; !Veeam.params.api_endpoint.endsWith('/')) {
            Veeam.params.api_endpoint += '/';
        }
    },

    request: function (url) {
        var response, request = new HttpRequest();
        if (typeof Veeam.params.http_proxy !== 'undefined' &amp;&amp; Veeam.params.http_proxy !== '') {
            request.setProxy(Veeam.params.http_proxy);
        }
        request.addHeader('Accept: application/json');
        request.addHeader('Authorization: Basic ' + btoa(Veeam.params.user + ':' + Veeam.params.password));
        request.post(Veeam.params.api_endpoint + 'api/sessionMngr');
        response = request.get(url);
        if (request.getStatus() !== 200 || response === null) {
            throw 'Request failed with status code ' + request.getStatus() + ': ' + response;
        }
        try {
            return JSON.parse(response);
        }
        catch (error) {
            throw 'Failed to parse response received from API.';
        }
    },

    getMetricsData: function() {
        var data = {};
        endpoints = {
            'backupFiles': 'api/backupFiles',
        };
        reports_summary = Veeam.request(Veeam.params.api_endpoint + 'api/reports/summary')
        if (typeof reports_summary !== 'object' || reports_summary.hasOwnProperty('Links') === false)
            throw 'Failed response parse. Check debug log for more information.';
        reports_summary.Links.forEach(function (field)  {
                data[field.Name] = Veeam.request(field.Href)
            })
        Object.keys(endpoints).forEach(function (key) {
            data[key] = Veeam.request(Veeam.params.api_endpoint + endpoints[key]);
            if (typeof data[key] !== 'object' || data[key].hasOwnProperty('Refs') === false)
                throw 'Failed response parse. Check debug log for more information.';
            data[key].Refs.forEach(function (field) {
                data[field.Name] = Veeam.request(field.Href)
            })
        
        })
        return data;
    }

};  
try {
    Veeam.setParams(JSON.parse(value));
    return JSON.stringify(Veeam.getMetricsData());
}
catch (error) {
    error += (String(error).endsWith('.')) ? '' : '.';
    Zabbix.log(3, '[ VEEAM MANAGER ] ERROR: ' + error);
    return JSON.stringify({'error': error});
}</params><description>The result of API requests is expressed in the JSON.</description><timeout>{$VEEAM.MANAGER.DATA.TIMEOUT}</timeout><parameters><parameter><name>api_endpoint</name><value>{$VEEAM.MANAGER.API.URL}</value></parameter><parameter><name>password</name><value>{$VEEAM.MANAGER.PASSWORD}</value></parameter><parameter><name>user</name><value>{$VEEAM.MANAGER.USER}</value></parameter><parameter><name>http_proxy</name><value>{$VEEAM.MANAGER.HTTP.PROXY}</value></parameter></parameters><tags><tag><tag>component</tag><value>raw</value></tag></tags></item><item><uuid>a0a1e67c99c64bd1a801c87eeda3977b</uuid><name>Veeam Manager: Running Jobs</name><type>DEPENDENT</type><key>veeam.manager.running.jobs</key><delay>0</delay><history>7d</history><description>Informs about the running jobs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.RunningJobs</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags></item><item><uuid>d7510e46c6094e09979ea7dad2828cef</uuid><name>Veeam Manager: Scheduled Backup Jobs</name><type>DEPENDENT</type><key>veeam.manager.scheduled.backup.jobs</key><delay>0</delay><history>7d</history><description>Informs about the scheduled backup jobs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.ScheduledBackupJobs</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags></item><item><uuid>de9f62198b5b42cdb25460315f4af949</uuid><name>Veeam Manager: Scheduled Jobs</name><type>DEPENDENT</type><key>veeam.manager.scheduled.jobs</key><delay>0</delay><history>7d</history><description>Informs about the scheduled jobs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.ScheduledJobs</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags></item><item><uuid>599a25d753ce4f5d8542d08569f2a136</uuid><name>Veeam Manager: Scheduled Replica Jobs</name><type>DEPENDENT</type><key>veeam.manager.scheduled.replica.jobs</key><delay>0</delay><history>7d</history><description>Informs about the scheduled replica jobs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.ScheduledReplicaJobs</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags></item><item><uuid>7d96ebb849c94d5b89656bdfa6398a1d</uuid><name>Veeam Manager: Total Job Runs</name><type>DEPENDENT</type><key>veeam.manager.scheduled.total.jobs</key><delay>0</delay><history>7d</history><description>Informs about the total job runs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.TotalJobRuns</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags></item><item><uuid>b39d33c9d5c544a2996736dbdccfcaff</uuid><name>Veeam Manager: Warnings Job Runs</name><type>DEPENDENT</type><key>veeam.manager.warning.jobs</key><delay>0</delay><history>7d</history><description>Informs about the warning job runs.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.JobStatistics.WarningsJobRuns</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>1h</parameter></parameters></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>component</tag><value>reports</value></tag></tags><triggers><trigger><uuid>f65998e99bb24e02a2810b632a4a3f4e</uuid><expression>last(/Veeam Backup Enterprise Manager by HTTP/veeam.manager.warning.jobs)&gt;{$VEEAM.MANAGER.JOB.MAX.WARN}</expression><name>Veeam Manager: Warning job runs is too high</name><event_name>Veeam Manager: Warning job runs is too high (over {$VEEAM.MANAGER.JOB.MAX.WARN})</event_name><priority>WARNING</priority><manual_close>YES</manual_close><tags><tag><tag>scope</tag><value>availability</value></tag></tags></trigger></triggers></item></items><discovery_rules><discovery_rule><uuid>d07b06fbd84d493bb38d61ac0824e794</uuid><name>Backup Files discovery</name><type>DEPENDENT</type><key>veeam.backup.files.discovery</key><delay>0</delay><filter><evaltype>AND</evaltype><conditions><condition><macro>{#TYPE}</macro><value>{$BACKUP.TYPE.MATCHES}</value><formulaid>C</formulaid></condition><condition><macro>{#TYPE}</macro><value>{$BACKUP.TYPE.NOT_MATCHES}</value><operator>NOT_MATCHES_REGEX</operator><formulaid>D</formulaid></condition><condition><macro>{#NAME}</macro><value>{$BACKUP.NAME.MATCHES}</value><formulaid>A</formulaid></condition><condition><macro>{#NAME}</macro><value>{$BACKUP.NAME.NOT_MATCHES}</value><operator>NOT_MATCHES_REGEX</operator><formulaid>B</formulaid></condition></conditions></filter><description>Discovery of all backup files created on, or imported to the backup servers that are connected to Veeam Backup Enterprise Manager.</description><item_prototypes><item_prototype><uuid>d3f87401602c48d3a837504ed08902db</uuid><name>Veeam Manager: Compression ratio [{#NAME}]</name><type>DEPENDENT</type><key>veeam.backup.compress.ratio[{#NAME}]</key><delay>0</delay><history>7d</history><description>Gets the data compression ratio with the name `[{#NAME}]`.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.['{#NAME}'].BackupFile.CompressRatio</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>backup</tag><value>{#NAME}</value></tag><tag><tag>component</tag><value>backups</value></tag></tags></item_prototype><item_prototype><uuid>0c5be137b40949c4946a09c57ccc7796</uuid><name>Veeam Manager: Data Size [{#NAME}]</name><type>DEPENDENT</type><key>veeam.backup.data.size[{#NAME}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>Gets the data size with the name `[{#NAME}]`.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.['{#NAME}'].BackupFile.DataSize</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>backup</tag><value>{#NAME}</value></tag><tag><tag>component</tag><value>backups</value></tag></tags></item_prototype><item_prototype><uuid>62d0b0341bac40f9a63f0fbf3639e0d0</uuid><name>Veeam Manager: Deduplication Ratio [{#NAME}]</name><type>DEPENDENT</type><key>veeam.backup.deduplication.ratio[{#NAME}]</key><delay>0</delay><history>7d</history><description>Gets the data deduplication ratio with the name `[{#NAME}]`.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.['{#NAME}'].BackupFile.DeduplicationRatio</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>backup</tag><value>{#NAME}</value></tag><tag><tag>component</tag><value>backups</value></tag></tags></item_prototype><item_prototype><uuid>098cc39afb88483f93a98c96fc1450d1</uuid><name>Veeam Manager: Backup Size [{#NAME}]</name><type>DEPENDENT</type><key>veeam.backup.file.size[{#NAME}]</key><delay>0</delay><history>7d</history><value_type>FLOAT</value_type><units>B</units><description>Gets the backup size with the name `[{#NAME}]`.</description><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.['{#NAME}'].BackupFile.BackupSize</parameter></parameters><error_handler>DISCARD_VALUE</error_handler></step></preprocessing><master_item><key>veeam.manager.get.metrics</key></master_item><tags><tag><tag>backup</tag><value>{#NAME}</value></tag><tag><tag>component</tag><value>backups</value></tag></tags></item_prototype></item_prototypes><master_item><key>veeam.manager.get.metrics</key></master_item><lld_macro_paths><lld_macro_path><lld_macro>{#NAME}</lld_macro><path>$.Name</path></lld_macro_path><lld_macro_path><lld_macro>{#TYPE}</lld_macro><path>$.Type</path></lld_macro_path><lld_macro_path><lld_macro>{#UID}</lld_macro><path>$.UID</path></lld_macro_path><lld_macro_path><lld_macro>{#URL}</lld_macro><path>$.Href</path></lld_macro_path></lld_macro_paths><preprocessing><step><type>JSONPATH</type><parameters><parameter>$.backupFiles.Refs</parameter></parameters></step><step><type>DISCARD_UNCHANGED_HEARTBEAT</type><parameters><parameter>6h</parameter></parameters></step></preprocessing></discovery_rule></discovery_rules><tags><tag><tag>class</tag><value>software</value></tag><tag><tag>target</tag><value>veeam</value></tag></tags><macros><macro><macro>{$BACKUP.NAME.MATCHES}</macro><value>.*</value><description>This macro is used in backup discovery rule.</description></macro><macro><macro>{$BACKUP.NAME.NOT_MATCHES}</macro><value>CHANGE_IF_NEEDED</value><description>This macro is used in backup discovery rule.</description></macro><macro><macro>{$BACKUP.TYPE.MATCHES}</macro><value>.*</value><description>This macro is used in backup discovery rule.</description></macro><macro><macro>{$BACKUP.TYPE.NOT_MATCHES}</macro><value>CHANGE_IF_NEEDED</value><description>This macro is used in backup discovery rule.</description></macro><macro><macro>{$VEEAM.MANAGER.API.URL}</macro><value>https://localhost:9398</value><description>Veeam Backup Enterprise Manager API endpoint is a URL in the format: `&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;`.</description></macro><macro><macro>{$VEEAM.MANAGER.DATA.TIMEOUT}</macro><value>10</value><description>A response timeout for API.</description></macro><macro><macro>{$VEEAM.MANAGER.HTTP.PROXY}</macro><description>Sets the HTTP proxy to `http_proxy` value. If this parameter is empty, then no proxy is used.</description></macro><macro><macro>{$VEEAM.MANAGER.JOB.MAX.FAIL}</macro><value>5</value><description>The maximum score of failed jobs (for a trigger expression).</description></macro><macro><macro>{$VEEAM.MANAGER.JOB.MAX.WARN}</macro><value>10</value><description>The maximum score of warning jobs (for a trigger expression).</description></macro><macro><macro>{$VEEAM.MANAGER.PASSWORD}</macro><type>SECRET_TEXT</type><description>The `password` of the Veeam Backup Enterprise Manager account.</description></macro><macro><macro>{$VEEAM.MANAGER.USER}</macro><type>SECRET_TEXT</type><description>The `user name` of the Veeam Backup Enterprise Manager account .</description></macro></macros></template></templates></zabbix_export>
